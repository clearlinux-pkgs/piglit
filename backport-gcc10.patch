From 1924e40adaa8e6c3b5ec8ad5296c96b1195332df Mon Sep 17 00:00:00 2001
From: Vinson Lee <vlee@freedesktop.org>
Date: Fri, 31 Jan 2020 22:03:42 -0800
Subject: [PATCH] util: Remove extra definition of piglit_automatic.

This patch fixes this build error with GCC 10.

/usr/bin/ld: CMakeFiles/piglitutil_gl.dir/piglit-glx-util.c.o:(.bss+0x0): multiple definition of `piglit_automatic'; CMakeFiles/piglitutil_gl.dir/piglit-framework-gl.c.o:(.bss+0x14): first defined here

Signed-off-by: Vinson Lee <vlee@freedesktop.org>
Reviewed-by: Jordan Justen <jordan.l.justen@intel.com>
Tested-by: Marge Bot <https://gitlab.freedesktop.org/mesa/piglit/merge_requests/215>
Part-of: <https://gitlab.freedesktop.org/mesa/piglit/merge_requests/215>
---
 tests/util/piglit-glx-util.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/tests/util/piglit-glx-util.c b/tests/util/piglit-glx-util.c
index 860fd7e3b..22c7f64a1 100644
--- a/tests/util/piglit-glx-util.c
+++ b/tests/util/piglit-glx-util.c
@@ -28,8 +28,6 @@
 #include "piglit-util-gl.h"
 #include "piglit-glx-util.h"
 
-int piglit_automatic;
-
 #ifndef _WIN32
 __attribute__((weak)) int piglit_width = 100;
 __attribute__((weak)) int piglit_height = 100;
-- 
2.26.2

From e06a2e92f03c8de694bc4f04fe9a8a0238c944da Mon Sep 17 00:00:00 2001
From: Vinson Lee <vlee@freedesktop.org>
Date: Fri, 31 Jan 2020 22:36:32 -0800
Subject: [PATCH] texturing: Move global variable definitions to common.c.

This patch fixes these build errors with GCC 10.

/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:38: multiple definition of `miplevels'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:38: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:41: multiple definition of `base_size'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:41: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:48: multiple definition of `level_size'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:48: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:79: multiple definition of `sampler'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:79: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:82: multiple definition of `swizzling'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:82: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: multiple definition of `minx'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: multiple definition of `miny'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: multiple definition of `minz'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: multiple definition of `maxx'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: multiple definition of `maxy'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: multiple definition of `maxz'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:83: first defined here
/usr/bin/ld: CMakeFiles/textureSamples.dir/common.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:84: multiple definition of `sample_count'; CMakeFiles/textureSamples.dir/textureSamples.c.o:/home/vlee/workspace/piglit/tests/texturing/shaders/common.h:84: first defined here

Signed-off-by: Vinson Lee <vlee@freedesktop.org>
Reviewed-by: Eric Engestrom <eric@engestrom.ch>
---
 tests/texturing/shaders/common.c |  7 +++++++
 tests/texturing/shaders/common.h | 15 ++++++++-------
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/tests/texturing/shaders/common.c b/tests/texturing/shaders/common.c
index 708524cb0..da461f596 100644
--- a/tests/texturing/shaders/common.c
+++ b/tests/texturing/shaders/common.c
@@ -28,6 +28,13 @@
  */
 #include "common.h"
 
+int miplevels;
+int base_size[3];
+int **level_size;
+struct sampler_info sampler;
+bool swizzling;
+int minx, miny, minz, maxx, maxy, maxz;
+int sample_count;
 int shader_version = 130;
 
 /**
diff --git a/tests/texturing/shaders/common.h b/tests/texturing/shaders/common.h
index f2d397d19..89df85fc8 100644
--- a/tests/texturing/shaders/common.h
+++ b/tests/texturing/shaders/common.h
@@ -35,17 +35,17 @@
  *
  * The total number of miplevels:
  */
-int miplevels;
+extern int miplevels;
 
 /** Size of the base level */
-int base_size[3];
+extern int base_size[3];
 
 /**
  * Multidimensional array containing the dimensions of each miplevel, indexed
  * by miplevel and then x/y/z.  For example, miplevel[0][1] is the height of
  * miplevel 0, while miplevel[5][2] is the number of slices in miplevel 5.
  */
-int **level_size;
+extern int **level_size;
 /** @} */
 
 struct sampler_info
@@ -76,12 +76,13 @@ struct sampler_info
 
 	/** GL_EXT_texture_swizzle setting: GL_RED/GREEN/BLUE/ALPHA/ZERO/ONE */
 	GLenum swizzle[4];
-} sampler;
+};
+extern struct sampler_info sampler;
 
 /** Whether or not we're using GL_EXT_texture_swizzle */
-bool swizzling;
-int minx, miny, minz, maxx, maxy, maxz;
-int sample_count;
+extern bool swizzling;
+extern int minx, miny, minz, maxx, maxy, maxz;
+extern int sample_count;
 extern int shader_version;
 
 /**
-- 
2.26.2

From e1a5383dbf8c75e65c3caed5133bfae066b77edc Mon Sep 17 00:00:00 2001
From: Vinson Lee <vlee@freedesktop.org>
Date: Fri, 7 Feb 2020 14:40:36 -0800
Subject: [PATCH] arb_internalformat_query2: Move global variable definitions
 to common.c.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This patch fixes these build errors with GCC 10.

/usr/bin/ld: CMakeFiles/arb_internalformat_query2-internalformat-size-checks.dir/common.c.o:tests/spec/arb_internalformat_query2/common.h:304: multiple definition of `valid_internalformats'; CMakeFiles/arb_internalformat_query2-internalformat-size-checks.dir/internalformat-size-checks.c.o:tests/spec/arb_internalformat_query2/common.h:304: first defined here
/usr/bin/ld: CMakeFiles/arb_internalformat_query2-internalformat-size-checks.dir/common.c.o:tests/spec/arb_internalformat_query2/common.h:305: multiple definition of `num_valid_internalformats'; CMakeFiles/arb_internalformat_query2-internalformat-size-checks.dir/internalformat-size-checks.c.o:tests/spec/arb_internalformat_query2/common.h:305: first defined here

Fixes: 1e60f1499e5b ("arb_internalformat_query2: test new ARB_ES3_compatibility internalformats")
Signed-off-by: Vinson Lee <vlee@freedesktop.org>
Reviewed-by: Jordan Justen <jordan.l.justen@intel.com>
Reviewed-by: Alejandro Pi√±eiro <apinheiro@igalia.com>
Tested-by: Marge Bot <https://gitlab.freedesktop.org/mesa/piglit/merge_requests/217>
Part-of: <https://gitlab.freedesktop.org/mesa/piglit/merge_requests/217>
---
 tests/spec/arb_internalformat_query2/common.c | 3 +++
 tests/spec/arb_internalformat_query2/common.h | 4 ++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/tests/spec/arb_internalformat_query2/common.c b/tests/spec/arb_internalformat_query2/common.c
index 9e62f0d30..67f04b133 100644
--- a/tests/spec/arb_internalformat_query2/common.c
+++ b/tests/spec/arb_internalformat_query2/common.c
@@ -30,6 +30,9 @@ typedef void (APIENTRY *GetInternalformat)(GLenum target, GLenum internalformat,
                                   GLenum pname, GLsizei bufsize,
                                   void *params);
 
+GLenum *valid_internalformats;
+unsigned num_valid_internalformats;
+
 /* This struct is intended to abstract the fact that there are two
  * really similar methods, and two really similar params (just change
  * the type). All the castings and decision about which method should
diff --git a/tests/spec/arb_internalformat_query2/common.h b/tests/spec/arb_internalformat_query2/common.h
index 86aa4c729..a388b7a1a 100644
--- a/tests/spec/arb_internalformat_query2/common.h
+++ b/tests/spec/arb_internalformat_query2/common.h
@@ -301,8 +301,8 @@ static const GLenum arb_es3_compatibility_valid_internalformats[] = {
         GL_COMPRESSED_SIGNED_RG11_EAC,
 };
 
-GLenum *valid_internalformats;
-unsigned num_valid_internalformats;
+extern GLenum *valid_internalformats;
+extern unsigned num_valid_internalformats;
 
 typedef struct _test_data test_data;
 
-- 
2.26.2

From 0732041a2db1cf21434a856dc558a5d44890127d Mon Sep 17 00:00:00 2001
From: Vinson Lee <vlee@freedesktop.org>
Date: Mon, 10 Feb 2020 21:55:51 -0800
Subject: [PATCH] glx_mesa_query_renderer: Fix error with GCC 10.

This patch fixes these build errors with GCC 10.

/usr/bin/ld: CMakeFiles/glx-query-renderer-coverage.dir/query-renderer-common.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:49: multiple definition of `piglit_glXQueryRendererStringMESA'; CMakeFiles/glx-query-renderer-coverage.dir/coverage.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:49: first defined here
/usr/bin/ld: CMakeFiles/glx-query-renderer-coverage.dir/query-renderer-common.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:50: multiple definition of `piglit_glXQueryCurrentRendererStringMESA'; CMakeFiles/glx-query-renderer-coverage.dir/coverage.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:50: first defined here
/usr/bin/ld: CMakeFiles/glx-query-renderer-coverage.dir/query-renderer-common.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:51: multiple definition of `piglit_glXQueryRendererIntegerMESA'; CMakeFiles/glx-query-renderer-coverage.dir/coverage.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:51: first defined here
/usr/bin/ld: CMakeFiles/glx-query-renderer-coverage.dir/query-renderer-common.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:52: multiple definition of `piglit_glXQueryCurrentRendererIntegerMESA'; CMakeFiles/glx-query-renderer-coverage.dir/coverage.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:52: first defined here
/usr/bin/ld: CMakeFiles/glx-query-renderer-coverage.dir/query-renderer-common.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:53: multiple definition of `piglit_glXCreateContextAttribsARB'; CMakeFiles/glx-query-renderer-coverage.dir/coverage.c.o:tests/spec/glx_mesa_query_renderer/query-renderer-common.h:53: first defined here

Fixes: f6ed23b558ca ("query_renderer: Add some common infrastructure for GLX_MESA_query_renderer tests")
Signed-off-by: Vinson Lee <vlee@freedesktop.org>
---
 .../glx_mesa_query_renderer/query-renderer-common.h    | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/tests/spec/glx_mesa_query_renderer/query-renderer-common.h b/tests/spec/glx_mesa_query_renderer/query-renderer-common.h
index 1121eca3e..6cfad9841 100644
--- a/tests/spec/glx_mesa_query_renderer/query-renderer-common.h
+++ b/tests/spec/glx_mesa_query_renderer/query-renderer-common.h
@@ -46,11 +46,11 @@ typedef const char *(*PFNGLXQUERYRENDERERSTRINGMESAPROC) (Display *dpy, int scre
 typedef const char *(*PFNGLXQUERYCURRENTRENDERERSTRINGMESAPROC) (int attribute);
 #endif /* GLX_MESA_query_renderer */
 
-PFNGLXQUERYRENDERERSTRINGMESAPROC piglit_glXQueryRendererStringMESA;
-PFNGLXQUERYCURRENTRENDERERSTRINGMESAPROC piglit_glXQueryCurrentRendererStringMESA;
-PFNGLXQUERYRENDERERINTEGERMESAPROC piglit_glXQueryRendererIntegerMESA;
-PFNGLXQUERYCURRENTRENDERERINTEGERMESAPROC piglit_glXQueryCurrentRendererIntegerMESA;
-PFNGLXCREATECONTEXTATTRIBSARBPROC piglit_glXCreateContextAttribsARB;
+extern PFNGLXQUERYRENDERERSTRINGMESAPROC piglit_glXQueryRendererStringMESA;
+extern PFNGLXQUERYCURRENTRENDERERSTRINGMESAPROC piglit_glXQueryCurrentRendererStringMESA;
+extern PFNGLXQUERYRENDERERINTEGERMESAPROC piglit_glXQueryRendererIntegerMESA;
+extern PFNGLXQUERYCURRENTRENDERERINTEGERMESAPROC piglit_glXQueryCurrentRendererIntegerMESA;
+extern PFNGLXCREATECONTEXTATTRIBSARBPROC piglit_glXCreateContextAttribsARB;
 
 #define glXQueryRendererStringMESA(dpy, screen, renderer, attribute) \
 	(*piglit_glXQueryRendererStringMESA)(dpy, screen, renderer, attribute)
-- 
2.26.2

